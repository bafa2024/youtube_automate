<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Debug Generation Error</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">Debug Image Generation Error</h1>
        
        <div class="bg-white p-6 rounded-lg shadow mb-4">
            <h2 class="text-lg font-semibold mb-4">Step 1: Check API Key</h2>
            <button onclick="checkApiKey()" class="px-4 py-2 bg-blue-500 text-white rounded">Check API Key</button>
            <div id="api-result" class="mt-2"></div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow mb-4">
            <h2 class="text-lg font-semibold mb-4">Step 2: Test Minimal Generation</h2>
            <button onclick="testGeneration()" class="px-4 py-2 bg-green-500 text-white rounded">Test Generation</button>
            <div id="gen-result" class="mt-2"></div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Console Output</h2>
            <pre id="console" class="bg-gray-100 p-4 rounded text-sm overflow-x-auto"></pre>
        </div>
    </div>
    
    <script>
        function log(msg, isError = false) {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            const prefix = isError ? '❌' : '✅';
            console.textContent += `[${time}] ${prefix} ${msg}\n`;
        }
        
        async function checkApiKey() {
            const resultDiv = document.getElementById('api-result');
            try {
                log('Checking API key...');
                const response = await fetch('/api/check-api-key');
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<p class="text-green-600">✅ API key found (source: ${data.source})</p>`;
                    log(`API key found from ${data.source}`);
                } else {
                    resultDiv.innerHTML = '<p class="text-red-600">❌ API key not configured</p>';
                    log('API key not configured', true);
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600">❌ Error: ${error.message}</p>`;
                log(`Error checking API key: ${error.message}`, true);
            }
        }
        
        async function testGeneration() {
            const resultDiv = document.getElementById('gen-result');
            
            try {
                // Step 1: Upload minimal script
                log('Uploading test script...');
                const scriptBlob = new Blob(['Test scene with mountains'], { type: 'text/plain' });
                const scriptForm = new FormData();
                scriptForm.append('file', scriptBlob, 'test.txt');
                
                const scriptResp = await fetch('/api/upload/script', {
                    method: 'POST',
                    body: scriptForm
                });
                
                if (!scriptResp.ok) {
                    throw new Error(`Script upload failed: ${await scriptResp.text()}`);
                }
                
                const scriptData = await scriptResp.json();
                log(`Script uploaded: ${scriptData.file_id}`);
                
                // Step 2: Upload minimal audio
                log('Uploading test audio...');
                const audioBlob = new Blob([new Uint8Array(1000)], { type: 'audio/mpeg' });
                const audioForm = new FormData();
                audioForm.append('file', audioBlob, 'test.mp3');
                
                const audioResp = await fetch('/api/upload/audio', {
                    method: 'POST',
                    body: audioForm
                });
                
                if (!audioResp.ok) {
                    throw new Error(`Audio upload failed: ${await audioResp.text()}`);
                }
                
                const audioData = await audioResp.json();
                log(`Audio uploaded: ${audioData.file_id}`);
                
                // Step 3: Try generation with detailed logging
                log('Starting generation...');
                const genForm = new FormData();
                genForm.append('script_file_id', scriptData.file_id);
                genForm.append('voice_file_id', audioData.file_id);
                genForm.append('script_text', 'Test scene');
                genForm.append('image_count', '1');
                genForm.append('style', 'Photorealistic');
                genForm.append('character_description', 'Test');
                genForm.append('voice_duration', '60');
                genForm.append('export_options', JSON.stringify({
                    images: true,
                    clips: false,
                    full_video: false
                }));
                
                log('Request payload prepared, sending...');
                const genResp = await fetch('/api/generate/ai-images', {
                    method: 'POST',
                    body: genForm
                });
                
                log(`Response status: ${genResp.status}`);
                const responseText = await genResp.text();
                log(`Response body: ${responseText}`);
                
                if (genResp.ok) {
                    try {
                        const genData = JSON.parse(responseText);
                        resultDiv.innerHTML = `<p class="text-green-600">✅ Generation started! Job ID: ${genData.job_id}</p>`;
                        log(`Success! Job ID: ${genData.job_id}`);
                    } catch (e) {
                        resultDiv.innerHTML = `<p class="text-yellow-600">⚠️ Generation started but response parsing failed</p>`;
                        log('Response parsing failed: ' + e.message, true);
                    }
                } else {
                    resultDiv.innerHTML = `<p class="text-red-600">❌ Generation failed: ${genResp.status}</p>`;
                    log(`Generation failed: ${responseText}`, true);
                    
                    // Try to parse error details
                    try {
                        const errorData = JSON.parse(responseText);
                        log(`Error detail: ${errorData.detail}`, true);
                    } catch (e) {
                        // Not JSON, that's ok
                    }
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-600">❌ Error: ${error.message}</p>`;
                log(`Test failed: ${error.message}`, true);
            }
        }
        
        // Auto-check API key on load
        window.onload = () => {
            log('Debug tool loaded');
            checkApiKey();
        };
    </script>
</body>
</html>