<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Image Generation</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow">
        <h1 class="text-2xl font-bold mb-4">Test Image Generation</h1>
        
        <div class="space-y-4">
            <div>
                <h3 class="font-semibold">1. Check API Key</h3>
                <button onclick="checkApiKey()" class="px-4 py-2 bg-blue-500 text-white rounded">Check API Key</button>
                <div id="api-key-result" class="mt-2"></div>
            </div>
            
            <div>
                <h3 class="font-semibold">2. Upload Test Script</h3>
                <button onclick="uploadScript()" class="px-4 py-2 bg-green-500 text-white rounded">Upload Script</button>
                <div id="script-result" class="mt-2"></div>
            </div>
            
            <div>
                <h3 class="font-semibold">3. Upload Test Audio</h3>
                <button onclick="uploadAudio()" class="px-4 py-2 bg-green-500 text-white rounded">Upload Audio</button>
                <div id="audio-result" class="mt-2"></div>
            </div>
            
            <div>
                <h3 class="font-semibold">4. Generate Images</h3>
                <button onclick="generateImages()" class="px-4 py-2 bg-purple-500 text-white rounded">Generate Images</button>
                <div id="generate-result" class="mt-2"></div>
            </div>
            
            <div class="mt-6 p-4 bg-gray-100 rounded">
                <h3 class="font-semibold">Console Log:</h3>
                <pre id="console-log" class="mt-2 text-sm overflow-x-auto"></pre>
            </div>
        </div>
    </div>
    
    <script>
        let scriptFileId = null;
        let audioFileId = null;
        let jobId = null;
        
        function log(message) {
            const logEl = document.getElementById('console-log');
            logEl.textContent += message + '\n';
            console.log(message);
        }
        
        async function checkApiKey() {
            try {
                const response = await fetch('/api/check-api-key');
                const result = document.getElementById('api-key-result');
                
                if (response.ok) {
                    result.innerHTML = '<span class="text-green-600">✓ API Key is set</span>';
                    log('API Key check: OK');
                } else {
                    result.innerHTML = '<span class="text-red-600">✗ API Key not set</span>';
                    log('API Key check: Not set - ' + response.status);
                }
            } catch (error) {
                log('Error checking API key: ' + error.message);
            }
        }
        
        async function uploadScript() {
            try {
                const testScript = "This is a test script about a beautiful sunset over mountains. The golden light casts long shadows across the landscape.";
                const blob = new Blob([testScript], { type: 'text/plain' });
                const formData = new FormData();
                formData.append('file', blob, 'test_script.txt');
                
                const response = await fetch('/api/upload/script', {
                    method: 'POST',
                    body: formData
                });
                
                const result = document.getElementById('script-result');
                if (response.ok) {
                    const data = await response.json();
                    scriptFileId = data.file_id;
                    result.innerHTML = '<span class="text-green-600">✓ Script uploaded: ' + data.filename + '</span>';
                    log('Script upload: OK - ID: ' + scriptFileId);
                } else {
                    const error = await response.text();
                    result.innerHTML = '<span class="text-red-600">✗ Upload failed</span>';
                    log('Script upload error: ' + error);
                }
            } catch (error) {
                log('Error uploading script: ' + error.message);
            }
        }
        
        async function uploadAudio() {
            try {
                // Create a fake audio file (just for testing)
                const audioData = new Uint8Array(1000);
                const blob = new Blob([audioData], { type: 'audio/mpeg' });
                const formData = new FormData();
                formData.append('file', blob, 'test_audio.mp3');
                
                const response = await fetch('/api/upload/audio', {
                    method: 'POST',
                    body: formData
                });
                
                const result = document.getElementById('audio-result');
                if (response.ok) {
                    const data = await response.json();
                    audioFileId = data.file_id;
                    result.innerHTML = '<span class="text-green-600">✓ Audio uploaded: ' + data.filename + '</span>';
                    log('Audio upload: OK - ID: ' + audioFileId);
                } else {
                    const error = await response.text();
                    result.innerHTML = '<span class="text-red-600">✗ Upload failed</span>';
                    log('Audio upload error: ' + error);
                }
            } catch (error) {
                log('Error uploading audio: ' + error.message);
            }
        }
        
        async function generateImages() {
            if (!scriptFileId || !audioFileId) {
                log('Error: Please upload script and audio first');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('script_file_id', scriptFileId);
                formData.append('voice_file_id', audioFileId);
                formData.append('script_text', 'Test script content');
                formData.append('image_count', '2');
                formData.append('style', 'Photorealistic');
                formData.append('character_description', 'Beautiful natural landscape');
                formData.append('voice_duration', '60');
                formData.append('export_options', JSON.stringify({
                    images: true,
                    clips: false,
                    full_video: false
                }));
                
                log('Sending generation request...');
                const response = await fetch('/api/generate/ai-images', {
                    method: 'POST',
                    body: formData
                });
                
                const result = document.getElementById('generate-result');
                if (response.ok) {
                    const data = await response.json();
                    jobId = data.job_id;
                    result.innerHTML = '<span class="text-green-600">✓ Generation started - Job ID: ' + jobId + '</span>';
                    log('Generation started: ' + JSON.stringify(data));
                    
                    // Start monitoring job
                    monitorJob();
                } else {
                    const error = await response.text();
                    result.innerHTML = '<span class="text-red-600">✗ Generation failed</span>';
                    log('Generation error: ' + error);
                }
            } catch (error) {
                log('Error starting generation: ' + error.message);
            }
        }
        
        async function monitorJob() {
            if (!jobId) return;
            
            const interval = setInterval(async () => {
                try {
                    const response = await fetch('/api/jobs/' + jobId);
                    if (response.ok) {
                        const job = await response.json();
                        log(`Job ${jobId}: ${job.status} - ${job.progress}% - ${job.message}`);
                        
                        if (job.status === 'completed' || job.status === 'failed') {
                            clearInterval(interval);
                            if (job.result_url) {
                                log('Job completed! Result: ' + job.result_url);
                            }
                        }
                    }
                } catch (error) {
                    log('Error monitoring job: ' + error.message);
                }
            }, 2000);
        }
    </script>
</body>
</html>